apiVersion: v1
kind: Secret
metadata:
  name: {{ include "chainloop.controlplane.fullname" . }}
  labels:
    {{- include "chainloop.controlplane.labels" . | nindent 4 }}
type: Opaque
{{- $hmacpass := include "common.secrets.passwords.manage" (dict "secret" (include "chainloop.controlplane.fullname" .) "key" "generated_jws_hmac_secret" "providedValues" (list "controlplane.auth.passphrase") "context" $) }}
data:
  # We store it also as a different key so it can be reused during upgrades by the common.secrets.passwords.manage helper
  generated_jws_hmac_secret: {{ $hmacpass }}
stringData:
  {{- if and .Values.sentry .Values.sentry.enabled }}
  config.observability.yaml: |
    observability:
      sentry:
        dsn: {{ required "Sentry DSN required" .Values.sentry.dsn | quote }}
        environment: {{ required "Sentry environment required" .Values.sentry.environment | quote }}
  {{- end }}
  config.secret.yaml: |
    data:
      database:
        driver: pgx
        source: {{include "controlplane.database.connection_string" . }}

    credentials_service: {{- include "chainloop.credentials_service_settings" . | indent 6 }}

    auth:
      oidc:
        {{- with .Values.controlplane.auth }}
        redirectURLScheme: {{ .redirectURLScheme | default "http" }}
        domain: "{{ required "oidc URL endpoint required" .oidc.url }}"
        clientID: "{{ required "oidc clientID required" .oidc.clientID }}"
        clientSecret: "{{ required "oidc clientSecret required" .oidc.clientSecret }}"
        {{- end }}

      # HMAC key used to sign the JWTs generated by the controlplane
      # NOTE: We are base64 encoding the value but can't remove it because it's quoted too by the helper
      # TODO: Make sure we inject the pass here verbatim
      generated_jws_hmac_secret: {{ $hmacpass }}

      # Private key used to sign the JWTs meant to be consumed by the CAS
      cas_robot_account_private_key_path: "/tmp/cas.private.key"
