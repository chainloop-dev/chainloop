# Chart Minor Version Upgrade Process (Type 2)

This process upgrades a Helm chart to the latest minor version, potentially including image updates.

## Step 1: Locate Target Chart Version

1. Navigate to [Bitnami Charts](https://github.com/bitnami/charts)
2. Open `bitnami/<chart-name>/CHANGELOG.md`
3. Find latest minor version (ensure no major version change)
4. Note target chart version

## Step 2: Version Validation

**MANDATORY**: Verify minor upgrade only:
```bash
CURRENT_CHART_VERSION="<current>"
TARGET_CHART_VERSION="<target>"

CURRENT_MAJOR=$(echo "$CURRENT_CHART_VERSION" | cut -d. -f1)
TARGET_MAJOR=$(echo "$TARGET_CHART_VERSION" | cut -d. -f1)

if [ "$CURRENT_MAJOR" != "$TARGET_MAJOR" ]; then
    echo "FORBIDDEN: Major version upgrade detected"
    exit 1
fi
```

## Step 3: Download and Extract Target Chart

```bash
# Pull chart to temporary location
helm pull bitnami/<chart-name> --version <target-version> --untar --untardir /tmp

# Examine structure
ls -la /tmp/<chart-name>/
```

## Step 4: Check for Image Changes

```bash
# Compare current vs target chart
diff deployment/charts/<chart-name>/Chart.yaml /tmp/<chart-name>/Chart.yaml

# Look for changes in:
# - appVersion field
# - images section (if present)
# - dependencies
```

## Step 5: Update Container Images (if changed)

**Execute only if images changed in target chart**:

1. **Locate new image versions**:
   - Pattern format: `<app-version>-<distro>-<distro-version>-r<revision>`
   - Example: `15.3.0-debian-12-r1`

2. **Get APP_VERSION from Dockerfile**:
   - Navigate to `bitnami/containers/<image>/<major-version>/<distro>-<version>/Dockerfile`
   - Extract `APP_VERSION` environment variable

3. **Update build configuration**:
   ```bash
   # Update commit hash in build workflow
   vi .github/workflows/build_external_container_images.yaml
   ```

## Step 6: Vendorize Chart Update

```bash
# Replace vendorized chart with new version
cp -r /tmp/<chart-name>/* deployment/charts/<chart-name>/

# Update Chart.yaml if images changed
vi deployment/charts/<chart-name>/Chart.yaml
# Set appVersion to APP_VERSION from Bitnami Containers

# Update values.yaml if needed
# Replace docker.io/bitnami/* with Chainloop registry paths
vi deployment/charts/<chart-name>/values.yaml
```

## Step 7: Update Dependencies (CRITICAL ORDER)

**Dependencies must be updated in this specific order**:

```bash
# 1. Update vendorized chart dependencies FIRST
cd deployment/charts/<chart-name>
helm dependency update
helm dependency build

# 2. Update main chart dependency version
cd ../../chainloop
vi Chart.yaml  # Update dependency version to match vendorized chart

# 3. Update main chart dependencies
helm dependency update
helm dependency build

cd ../..
```

## Step 8: Clean Up

```bash
# Remove temporary files
rm -rf /tmp/<chart-name>

# Verify working directory
git status
```

## Step 9: Verification

```bash
# Lint charts
helm lint deployment/charts/<chart-name>
helm lint deployment/chainloop

# Template validation
helm template deployment/charts/<chart-name>
helm template deployment/chainloop

# Local testing
cd devel && docker compose up

# Verify image consistency
grep -r "appVersion\|image.*tag" deployment/charts/<chart-name>/
grep -r "<chart-name>" .github/workflows/build_external_container_images.yaml
```

## Files Modified

- `deployment/charts/<chart-name>/Chart.yaml` - Chart version and appVersion
- `deployment/charts/<chart-name>/values.yaml` - Image references
- `deployment/charts/<chart-name>/Chart.lock` - Dependency lock (regenerated)
- `deployment/charts/<chart-name>/templates/*` - All chart templates (vendorized)
- `deployment/chainloop/Chart.yaml` - Main chart dependency version
- `deployment/chainloop/Chart.lock` - Main dependency lock (regenerated)
- `.github/workflows/build_external_container_images.yaml` - Image build references (if images changed)

## Important Notes

- Always vendorize first, then update main chart dependencies
- Chart.lock files are regenerated by `helm dependency build`
- Image registry paths must use Chainloop registry (not docker.io/bitnami)
- Commit hashes ensure reproducible builds
