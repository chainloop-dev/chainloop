//
// Copyright 2025 The Chainloop Authors.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

// {{.Description}}
//
// Build:
//   tinygo build -target=wasi -o policy.wasm policy.go
//
// Test:
//   chainloop policy develop eval --policy policy.yaml --material <your-material> --kind {{.MaterialKind}}
package main

import (
	chainlooppolicy "github.com/chainloop-dev/wasi-policy-sdks/go"
)

// Input represents the expected input structure
type Input struct {
	// Define your input fields here
	// Example: Message string `json:"message"`
}

//export Execute
func Execute() int32 {
	return chainlooppolicy.Run(func() {
		// Extract policy arguments (optional configuration)
		args, err := chainlooppolicy.GetArgs()
		if err != nil {
			chainlooppolicy.OutputResult(chainlooppolicy.Skip(err.Error()))
			return
		}

		chainlooppolicy.LogInfo("Executing policy: {{.Name}}")

		// Parse material
		var input Input
		if err := chainlooppolicy.GetMaterialJSON(&input); err != nil {
			chainlooppolicy.OutputResult(chainlooppolicy.Skip(err.Error()))
			return
		}

		// Validate
		result := validate(input, args)

		// Output result
		chainlooppolicy.OutputResult(result)
	})
}

// validate checks the input for compliance
func validate(input Input, args map[string]string) chainlooppolicy.Result {
	result := chainlooppolicy.Success()

	// Add your validation logic here
	// Example:
	// if input.Message == "" {
	//     result.AddViolation("message cannot be empty")
	// }

	if result.HasViolations() {
		chainlooppolicy.LogError("Validation failed with %d violations", len(result.Violations))
	} else {
		chainlooppolicy.LogInfo("Validation passed")
	}

	return result
}

func main() {}
