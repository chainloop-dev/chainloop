-- create "organizations" table
CREATE TABLE "organizations" ("id" uuid NOT NULL, "name" character varying NOT NULL DEFAULT 'default', "created_at" timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP, PRIMARY KEY ("id"));
-- create "workflow_contracts" table
CREATE TABLE "workflow_contracts" ("id" uuid NOT NULL, "name" character varying NOT NULL, "created_at" timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP, "deleted_at" timestamptz NULL, "organization_workflow_contracts" uuid NULL, PRIMARY KEY ("id"), CONSTRAINT "workflow_contracts_organizations_workflow_contracts" FOREIGN KEY ("organization_workflow_contracts") REFERENCES "organizations" ("id") ON UPDATE NO ACTION ON DELETE CASCADE);
-- create "workflows" table
CREATE TABLE "workflows" ("id" uuid NOT NULL, "name" character varying NOT NULL, "project" character varying NULL, "team" character varying NULL, "runs_count" bigint NOT NULL DEFAULT 0, "created_at" timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP, "deleted_at" timestamptz NULL, "organization_id" uuid NOT NULL, "workflow_contract" uuid NOT NULL, PRIMARY KEY ("id"), CONSTRAINT "workflows_organizations_workflows" FOREIGN KEY ("organization_id") REFERENCES "organizations" ("id") ON UPDATE NO ACTION ON DELETE CASCADE, CONSTRAINT "workflows_workflow_contracts_contract" FOREIGN KEY ("workflow_contract") REFERENCES "workflow_contracts" ("id") ON UPDATE NO ACTION ON DELETE NO ACTION);
-- create "robot_accounts" table
CREATE TABLE "robot_accounts" ("id" uuid NOT NULL, "name" character varying NOT NULL, "created_at" timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP, "revoked_at" timestamptz NULL, "workflow_robotaccounts" uuid NULL, PRIMARY KEY ("id"), CONSTRAINT "robot_accounts_workflows_robotaccounts" FOREIGN KEY ("workflow_robotaccounts") REFERENCES "workflows" ("id") ON UPDATE NO ACTION ON DELETE CASCADE);
-- create "workflow_contract_versions" table
CREATE TABLE "workflow_contract_versions" ("id" uuid NOT NULL, "body" bytea NOT NULL, "revision" bigint NOT NULL DEFAULT 1, "created_at" timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP, "workflow_contract_versions" uuid NULL, PRIMARY KEY ("id"), CONSTRAINT "workflow_contract_versions_workflow_contracts_versions" FOREIGN KEY ("workflow_contract_versions") REFERENCES "workflow_contracts" ("id") ON UPDATE NO ACTION ON DELETE SET NULL);
-- create "workflow_runs" table
CREATE TABLE "workflow_runs" ("id" uuid NOT NULL, "created_at" timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP, "finished_at" timestamptz NULL, "state" character varying NOT NULL DEFAULT 'initialized', "reason" text NULL, "run_url" character varying NULL, "runner_type" character varying NULL, "attestation" jsonb NULL, "robot_account_workflowruns" uuid NULL, "workflow_workflowruns" uuid NULL, "workflow_run_contract_version" uuid NULL, PRIMARY KEY ("id"), CONSTRAINT "workflow_runs_robot_accounts_workflowruns" FOREIGN KEY ("robot_account_workflowruns") REFERENCES "robot_accounts" ("id") ON UPDATE NO ACTION ON DELETE SET NULL, CONSTRAINT "workflow_runs_workflow_contract_versions_contract_version" FOREIGN KEY ("workflow_run_contract_version") REFERENCES "workflow_contract_versions" ("id") ON UPDATE NO ACTION ON DELETE CASCADE, CONSTRAINT "workflow_runs_workflows_workflowruns" FOREIGN KEY ("workflow_workflowruns") REFERENCES "workflows" ("id") ON UPDATE NO ACTION ON DELETE CASCADE);
-- create index "workflowrun_created_at_id" to table: "workflow_runs"
CREATE INDEX "workflowrun_created_at_id" ON "workflow_runs" ("created_at", "id");
-- create index "workflowrun_created_at_state" to table: "workflow_runs"
CREATE INDEX "workflowrun_created_at_state" ON "workflow_runs" ("created_at", "state");
-- create "integrations" table
CREATE TABLE "integrations" ("id" uuid NOT NULL, "kind" character varying NOT NULL, "description" character varying NULL, "secret_name" character varying NOT NULL, "created_at" timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP, "configuration" bytea NULL, "deleted_at" timestamptz NULL, "organization_integrations" uuid NOT NULL, PRIMARY KEY ("id"), CONSTRAINT "integrations_organizations_integrations" FOREIGN KEY ("organization_integrations") REFERENCES "organizations" ("id") ON UPDATE NO ACTION ON DELETE CASCADE);
-- create "integration_attachments" table
CREATE TABLE "integration_attachments" ("id" uuid NOT NULL, "created_at" timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP, "configuration" bytea NULL, "deleted_at" timestamptz NULL, "integration_attachment_integration" uuid NOT NULL, "integration_attachment_workflow" uuid NOT NULL, PRIMARY KEY ("id"), CONSTRAINT "integration_attachments_integrations_integration" FOREIGN KEY ("integration_attachment_integration") REFERENCES "integrations" ("id") ON UPDATE NO ACTION ON DELETE CASCADE, CONSTRAINT "integration_attachments_workflows_workflow" FOREIGN KEY ("integration_attachment_workflow") REFERENCES "workflows" ("id") ON UPDATE NO ACTION ON DELETE CASCADE);
-- create "users" table
CREATE TABLE "users" ("id" uuid NOT NULL, "email" character varying NOT NULL, "created_at" timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP, PRIMARY KEY ("id"));
-- create index "users_email_key" to table: "users"
CREATE UNIQUE INDEX "users_email_key" ON "users" ("email");
-- create "memberships" table
CREATE TABLE "memberships" ("id" uuid NOT NULL, "current" boolean NOT NULL DEFAULT false, "created_at" timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP, "updated_at" timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP, "organization_memberships" uuid NOT NULL, "user_memberships" uuid NOT NULL, PRIMARY KEY ("id"), CONSTRAINT "memberships_organizations_memberships" FOREIGN KEY ("organization_memberships") REFERENCES "organizations" ("id") ON UPDATE NO ACTION ON DELETE CASCADE, CONSTRAINT "memberships_users_memberships" FOREIGN KEY ("user_memberships") REFERENCES "users" ("id") ON UPDATE NO ACTION ON DELETE CASCADE);
-- create index "membership_organization_memberships_user_memberships" to table: "memberships"
CREATE UNIQUE INDEX "membership_organization_memberships_user_memberships" ON "memberships" ("organization_memberships", "user_memberships");
-- create "oci_repositories" table
CREATE TABLE "oci_repositories" ("id" uuid NOT NULL, "repo" character varying NOT NULL, "secret_name" character varying NOT NULL, "created_at" timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP, "validation_status" character varying NOT NULL DEFAULT 'OK', "validated_at" timestamptz NOT NULL DEFAULT CURRENT_TIMESTAMP, "organization_oci_repositories" uuid NOT NULL, PRIMARY KEY ("id"), CONSTRAINT "oci_repositories_organizations_oci_repositories" FOREIGN KEY ("organization_oci_repositories") REFERENCES "organizations" ("id") ON UPDATE NO ACTION ON DELETE CASCADE);
