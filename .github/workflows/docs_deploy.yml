name: Deploy Documentation

on:
  push:
    tags: ['v*.*.*']
  workflow_dispatch:

# Limit to a single workflow
concurrency: "deploy-to-prod"

jobs:
  chainloop_init:
    name: Chainloop Init
    uses: chainloop-dev/labs/.github/workflows/chainloop_init.yml@7f4de29435dc009326587051f507d2cd8c77d28b
    secrets:
      api_token: ${{ secrets.CHAINLOOP_ROBOT_ACCOUNT_DOCS_RELEASE }}
    with:
      chainloop_labs_branch: 7f4de29435dc009326587051f507d2cd8c77d28b

  deploy_docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./docs
    steps:
      - uses: actions/checkout@cd7d8d697e10461458bc61a30d094dc601a8b017
        with:
          sparse-checkout: |
            docs
          sparse-checkout-cone-mode: false

      - name: Install Syft
        run: |
          # Install Syft
          wget --no-verbose https://raw.githubusercontent.com/anchore/syft/main/install.sh -O - | sh -s -- -b /usr/local/bin

      - uses: actions/setup-node@c2ac33f2c62f978d6c944d9648125a294e56dc0b
        with:
          node-version: 18

      - name: yarn install
        run: yarn install

      - name: Build
        run: netlify build

      - name: Deploy
        run: netlify deploy --prod

      - name: Generate reports
        run: |
          mkdir -p reports
          tar -czf reports/build.tar.gz build

      - uses: anchore/sbom-action@a5afbb185c4d9799c758f05e496032af75ae9128
        with:
          path: .
          format: cyclonedx-json
          upload-artifact: false
          output-file: docs/reports/sbom.cyclonedx.json

      - uses: anchore/sbom-action@a5afbb185c4d9799c758f05e496032af75ae9128
        with:
          path: .
          format: spdx-json
          upload-artifact: false
          output-file: docs/reports/sbom.spdx.json
  
      # Upload artifacts so they are shared with the chainloop job
      - uses: actions/upload-artifact@ef09cdac3e2d3e60d8ccadda691f4f1cec5035cb
        with:
          name: reports
          path: docs/reports/*

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
      NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  chainloop_push:
    name: Chainloop Push
    uses: chainloop-dev/labs/.github/workflows/chainloop_push.yml@7f4de29435dc009326587051f507d2cd8c77d28b
    needs:
      - deploy_docs
    secrets:
      api_token: ${{ secrets.CHAINLOOP_ROBOT_ACCOUNT_DOCS_RELEASE }}
      signing_key: ${{ secrets.COSIGN_KEY }}
      signing_key_password: ${{ secrets.COSIGN_PASSWORD }}
    with:
      attestation_name: "docs"
      chainloop_labs_branch: 7f4de29435dc009326587051f507d2cd8c77d28b