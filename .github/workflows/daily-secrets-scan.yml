name: Daily Secrets Scan

on:
  schedule:
    # Run daily at 9:00 AM UTC
    - cron: "0 9 * * *"
  workflow_dispatch: # Allow manual triggering

jobs:
  daily-secrets-scan:
    name: Daily Secrets Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    env:
      CHAINLOOP_TOKEN: ${{ secrets.CHAINLOOP_TOKEN }}
      CHAINLOOP_WORKFLOW_NAME: daily-secrets-detection
      CHAINLOOP_PROJECT_NAME: chainloop

    steps:
      - uses: actions/checkout@v4

      - name: Install Chainloop
        run: |
          curl -sfL https://dl.chainloop.dev/cli/install.sh | bash -s -- --ee

      - name: Initialize Attestation
        run: |
          chainloop attestation init --workflow ${CHAINLOOP_WORKFLOW_NAME} --project ${CHAINLOOP_PROJECT_NAME}

      # Note: We manually install the gitleaks binary instead of using gitleaks/gitleaks-action
      # because the GitHub Action requires a commercial license for organization accounts
      # (see https://github.com/gitleaks/gitleaks-action/blob/master/LICENSE.txt).
      # The gitleaks CLI itself is MIT licensed and free to use.
      # We extract to /tmp to avoid overwriting repo files (README.md, LICENSE) from the tarball.
      - name: Install Gitleaks
        run: |
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.30.0/gitleaks_8.30.0_linux_x64.tar.gz
          mkdir -p /tmp/gitleaks-install
          tar -xzf gitleaks_8.30.0_linux_x64.tar.gz -C /tmp/gitleaks-install
          sudo install /tmp/gitleaks-install/gitleaks /usr/local/bin/
          rm -rf /tmp/gitleaks-install gitleaks_8.30.0_linux_x64.tar.gz
          gitleaks version

      - name: Run Gitleaks Scan
        run: |
          gitleaks dir . \
            --report-format json \
            --report-path gitleaks-report.json \
            --config .github/workflows/utils/.gitleaks.toml \
            || true

      - name: Add Gitleaks Report to Attestation
        run: |
          chainloop attestation add \
            --name gitleaks-scan \
            --value gitleaks-report.json \
            --kind GITLEAKS_JSON

      - name: Finish and Push Attestation
        if: ${{ success() }}
        run: |
          chainloop attestation push

      - name: Mark attestation as failed
        if: ${{ failure() }}
        run: |
          chainloop attestation reset

      - name: Mark attestation as cancelled
        if: ${{ cancelled() }}
        run: |
          chainloop attestation reset --trigger cancellation
